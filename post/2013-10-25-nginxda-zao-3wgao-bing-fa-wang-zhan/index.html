<!DOCTYPE html>
<html lang="zh_CN">
<head>
<meta charset="utf-8">
<title>Nginx打造3w高并发网站 - 老运维人员</title>
  <meta name="author" content="皓禹">
  <meta name="description" content="">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="http://www.linuxeden.com/favicon.ico">
  <link rel="shortcut icon" href="http://www.linuxeden.com/favicon.ico"  type="image/x-icon" />
<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link href="http://opslinux.com/theme/css/1.4.0/bootstrap.css" rel="stylesheet">
<link href="http://opslinux.com/theme/css/style.css" rel="stylesheet" type="text/css" media="all">
<link href="http://opslinux.com/atom.xml" type="application/atom+xml" rel="alternate" title="老运维人员 ATOM Feed" />
<link href="http://opslinux.com/rss.xml" type="application/atom+xml" rel="alternate" title="老运维人员 RSS Feed" />
</head>
  <body>
    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="http://opslinux.com">老运维人员</a>
<ul class="nav">
                              <li><a href="/categories.html">Categories</a></li>
                              <li><a href="/archives.html">Archives</a></li>
                              <li><a href="/tags.html">Tags</a></li>
                              <li><a href="/pages/about.html">About</a></li>
                              <li><a href="/pages/links.html">Links</a></li>              
                              
							  <li><a href="/random.html">Random</a></li>

            </ul>
			<div id="search"><form method="get" action="/search.html"><input type="text" value="" name="q" id="s"></form></div>
        </div>
      </div>
    </div>
    <div class="container"> 
	   <div class="content">  
 <div class="page-header">
  <h1>Nginx打造3w高并发网站</h1>
</div>
<div class="row">
  <div class="span10">
<div class="section" id="nginx">
<h2>Nginx 优化</h2>
<div class="section" id="id1">
<h3>编译安装过程优化</h3>
<p>在编译Nginx时，默认以debug模式进行，而在debug模式下会插入很多跟踪和ASSERT之类的信息，编译完成后，一个Nginx要有好几兆字节。在编译前取消Nginx的debug模式，编译完成后Nginx只有几百千字节，因此可以在编译之前，修改相关源码，取消debug模式，具体方法如下：
在Nginx源码文件被解压后，找到源码目录下的auto/cc/gcc文件，在其中找到如下几行:</p>
<pre class="literal-block">
# debug
CFLAGS=”$CFLAGS -g”
</pre>
<div class="section" id="cpucpu">
<h4>为特定的CPU指定CPU类型编译优化</h4>
<p>在编译Nginx时，默认的GCC编译参数是“-O”，要优化GCC编译，可以使用以下两个参数:</p>
<pre class="literal-block">
--with-cc-opt='-O3'
--with-cpu-opt=CPU  #为特定的 CPU 编译，有效的值包括：pentium, pentiumpro, pentium3, pentium4, athlon, opteron, amd64, sparc32, sparc64, ppc64
</pre>
<p>要确定CPU类型，可以通过如下命令:</p>
<pre class="literal-block">
[root&#64;localhost home]#cat /proc/cpuinfo | grep &quot;model name&quot;
</pre>
</div>
<div class="section" id="tcmallocnginx">
<h4>利用TCMalloc优化Nginx的性能</h4>
<p>TCMalloc的全称为Thread-Caching Malloc，是谷歌开发的开源工具“google-perftools”中的一个成员。与标准的glibc库的malloc相比，TCMalloc库在内存分配效率和速度上要高很多，这在很大程度上提高了服务器在高并发情况下的性能，从而降低系统负载。下面简单介绍如何为Nginx添加TCMalloc库支持。
要安装TCMalloc库，需要安装libunwind（32位操作系统不需要安装）和google-perftools两个软件包，libunwind库为基于64位CPU和操作系统的程序提供了基本函数调用链和函数调用寄存器功能。下面介绍利用TCMalloc优化Nginx的具体操作过程：</p>
<div class="section" id="libunwind">
<h5>1.安装libunwind库</h5>
<p>可以从http://download.savannah.gnu.org/releases/libunwind下载相应的libunwind版本，这里下载的是libunwind-0.99-alpha.tar.gz，安装过程如下</p>
<pre class="literal-block">
[root&#64;localhost home]#tar zxvf libunwind-0.99-alpha.tar.gz
[root&#64;localhost home]# cd libunwind-0.99-alpha/
[root&#64;localhost libunwind-0.99-alpha]#CFLAGS=-fPIC ./configure
[root&#64;localhost libunwind-0.99-alpha]#make CFLAGS=-fPIC
[root&#64;localhost libunwind-0.99-alpha]#make CFLAGS=-fPIC install
</pre>
</div>
<div class="section" id="google-perftools">
<h5>2.安装google-perftools</h5>
<p>可以从http://google-perftools.googlecode.com下载相应的google-perftools版本，这里下载的是google-perftools-1.8.tar.gz，安装过程如下:</p>
<pre class="literal-block">
[root&#64;localhost home]# tar zxvf google-perftools-1.8.tar.gz
[root&#64;localhost home]# cd google-perftools-1.8/
[root&#64;localhost google-perftools-1.8]# ./configure
[root&#64;localhost google-perftools-1.8]# make &amp;&amp; make install
[root&#64;localhost google-perftools-1.8]# echo &quot;/usr/local/lib&quot; &gt; /etc/ld.so.conf.d/usr_local_lib.conf
[root&#64;localhost google-perftools-1.8]# ldconfig
</pre>
<p>至此，google-perftools安装完成。</p>
</div>
<div class="section" id="id2">
<h5>3.重新编译Nginx</h5>
<p>为了使Nginx支持google-perftools，需要在安装过程中添加“–with-google_perftools_module”选项重新编译Nginx，安装代码如下:</p>
<pre class="literal-block">
[root&#64;localhostnginx-0.7.65]#./configure \
&gt;--with-google_perftools_module --with-http_stub_status_module  --prefix=/opt/nginx
[root&#64;localhost nginx-0.7.65]#make
[root&#64;localhost nginx-0.7.65]#make install
</pre>
<p>到这里Nginx安装完成。</p>
</div>
<div class="section" id="id3">
<h5>4.为google-perftools添加线程目录</h5>
<p>创建一个线程目录，这里将文件放在/tmp/tcmalloc下，操作如下:</p>
<pre class="literal-block">
[root&#64;localhost home]#mkdir /tmp/tcmalloc
[root&#64;localhost home]#chmod 0777 /tmp/tcmalloc
</pre>
</div>
<div class="section" id="id4">
<h5>5.修改Nginx主配置文件</h5>
<p>修改nginx.conf文件，在pid这行的下面添加如下代码:</p>
<pre class="literal-block">
#pid        logs/nginx.pid;
google_perftools_profiles /tmp/tcmalloc;
</pre>
<p>接着，重启Nginx，完成google-perftools的加载。</p>
</div>
<div class="section" id="id5">
<h5>6.验证运行状态</h5>
<p>为了验证google-perftools已经正常加载，通过如下命令查看:</p>
<pre class="literal-block">
[root&#64; localhost home]# lsof -n | grep tcmalloc
nginx      2395 nobody   9w  REG    8,8       0    1599440 /tmp/tcmalloc.2395
nginx      2396 nobody   11w REG   8,8       0    1599443 /tmp/tcmalloc.2396
nginx      2397 nobody   13w REG  8,8        0    1599441  /tmp/tcmalloc.2397
nginx     2398 nobody    15w REG  8,8     0    1599442 /tmp/tcmalloc.2398
</pre>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">/Users/ce/workspace/pelican/blog/content/nginx优化.rst</tt>, line 105)</p>
Literal block ends without a blank line; unexpected unindent.</div>
<p>由于在Nginx配置文件中，设置worker_processes的值为4，因此开启了4个Nginx线程，每个线程会有一行记录。每个线程文件后面的数字值就是启动的Nginx的PID值。
至此，利用TCMalloc优化Nginx的操作完成。</p>
</div>
</div>
</div>
<div class="section" id="id6">
<h3>Nginx内核参数优化</h3>
<p>内核参数的优化，主要是在Linux系统中针对Nginx应用而进行的系统内核参数优化，常见的优化参数值如下。</p>
<p>下面给出一个优化实例以供参考:</p>
<pre class="literal-block">
net.ipv4.tcp_max_tw_buckets = 6000
net.ipv4.ip_local_port_range = 1024 65000
net.ipv4.tcp_tw_recycle = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_syncookies = 1
net.core.somaxconn = 262144
net.core.netdev_max_backlog = 262144
net.ipv4.tcp_max_orphans = 262144
net.ipv4.tcp_max_syn_backlog = 262144
net.ipv4.tcp_synack_retries = 1
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_fin_timeout = 1
net.ipv4.tcp_keepalive_time = 30
</pre>
<p>将上面的内核参数值加入/etc/sysctl.conf文件中，然后执行如下命令使之生效:</p>
<pre class="literal-block">
[root&#64; localhost home]#/sbin/sysctl -p
</pre>
<p>下面是对实例中选项的含义进行介绍：</p>
<p>net.ipv4.tcp_max_tw_buckets参数用来设定timewait的数量，默认是180000，这里设为6000。</p>
<p>net.ipv4.ip_local_port_range选项用来设定允许系统打开的端口范围。</p>
<p>net.ipv4.tcp_tw_recycle选项用于设置启用timewait快速回收。</p>
<p>net.ipv4.tcp_tw_reuse选项用于设置开启重用，允许将TIME-WAIT sockets重新用于新的TCP连接。</p>
<p>net.ipv4.tcp_syncookies选项用于设置开启SYN Cookies，当出现SYN等待队列溢出时，启用cookies进行处理。</p>
<p>net.core.somaxconn选项默认值是128， 这个参数用于调节系统同时发起的tcp连接数，在高并发的请求中，默认的值可能会导致链接超时或者重传，因此，需要结合并发请求数来调节此值。</p>
<p>net.core.netdev_max_backlog选项表示当每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许发送到队列的数据包的最大数目。</p>
<p>net.ipv4.tcp_max_orphans选项用于设定系统中最多有多少个TCP套接字不被关联到任何一个用户文件句柄上。如果超过这个数字，孤立连接将立即被复位并打印出警告信息。这个限制只是为了防止简单的DoS攻击。不能过分依靠这个限制甚至人为减小这个值，更多的情况是增加这个值。</p>
<p>net.ipv4.tcp_max_syn_backlog选项用于记录那些尚未收到客户端确认信息的连接请求的最大值。对于有128MB内存的系统而言，此参数的默认值是1024，对小内存的系统则是128。</p>
<p>net.ipv4.tcp_synack_retries参数的值决定了内核放弃连接之前发送SYN+ACK包的数量。</p>
<p>net.ipv4.tcp_syn_retries选项表示在内核放弃建立连接之前发送SYN包的数量。</p>
<p>net.ipv4.tcp_fin_timeout选项决定了套接字保持在FIN-WAIT-2状态的时间。默认值是60秒。正确设置这个值非常重要，有时候即使一个负载很小的Web服务器，也会出现因为大量的死套接字而产生内存溢出的风险。</p>
<p>net.ipv4.tcp_keepalive_time选项表示当keepalive启用的时候，TCP发送keepalive消息的频度。默认值是2（单位是小时）。</p>
</div>
</div>

   <hr>
   <div class="pagination">
      <ul>
	          <li class="prev"><a href="http://opslinux.com/post/2013-09-14-shi-yong-vagrantda-zao-ni-de-xu-ni-huan-jing/">← Previous</a></li>
		        <li><a href="/archives.html">Archive</a></li>
		        <li class="next"><a href="/">Next →</a></li>
		      </ul>
  </div>
  

<!-- Duoshuo Comment BEGIN -->
  <div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"ops"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- Duoshuo Comment END -->
  </div>
   
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>2013-10-25 By <a href="http://opslinux.com/author/chuang-e.html">创e</a></span></div>
	<h4>Latest Articles</h4>
	<script language="JavaScript" src="http://feed2js.liluohost.com/feed2js.php?src=http%3A%2F%2Fopslinux.com%2Frss.xml&num=10&utf=y"  charset="UTF-8" type="text/javascript"></script>
	    	
  </div>
</div>
</div>
<footer>
<p>&copy; 2013 - 老运维人员 Powered by <a href="http://blog.getpelican.com/">Pelican</a>
          with help from <a href="http://jekyllbootstrap.com/" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>
    </div> <!-- /container -->
  </body>
</html>